import &ArtStandardLib
{missing} = &ArtCommunicationStatus
{ElasticsearchPipeline} = &ArtEryElasticsearch
{pipelines} = &ArtEry

defineModule module, suite: ->
  @timeout 10000

  postSearch = null

  setup ->
    &ArtEry._reset()

    # http://blog.pixlee.com/finding-hashtags-in-elasticsearch

    class PostSearch extends ElasticsearchPipeline
      @mapping
        properties:
          text:   type: :text analyzer: :english_with_hashtags
          text2:  type: :text analyzer: :english

        settings:
          analysis:
            char_filter:
              space_hashtags:
                type:     :mapping
                mappings: [] "#=>|#"

            filter:
              english_stop:               type: :stop            stopwords: :_english_
              # english_keywords:           type: :keyword_marker  keywords:  []
              english_stemmer:            type: :stemmer         language:  :english
              english_possessive_stemmer: type: :stemmer         language:  :possessive_english
              hashtag_as_alphanum:
                type: :word_delimiter
                type_table:
                  "# => ALPHANUM"
                  "@ => ALPHANUM"

            analyzer:
              english_with_hashtags:
                type:         :custom
                char_filter:  :space_hashtags
                tokenizer:    :whitespace
                filter:
                  :english_possessive_stemmer
                  :lowercase
                  :hashtag_as_alphanum
                  :english_stop
                  # :english_keywords
                  :english_stemmer

    {postSearch} = pipelines

    postSearch.indexExists()
    .then (exists) -> postSearch.deleteIndex data: force: true if exists
    .then -> postSearch.initialize()

  test "initialize" ->

  test "index then search", ->
    postSearch.update key: :123, data: text: "" This, my friends, is the #winnings!
    .then -> timeout 1000 # it takes > 500ms for the new entry to show up in the search...
    .then ->
      Promise.all []
        postSearch.elasticsearch data: query: match: text: "winnings"
        postSearch.elasticsearch data: query: match: text: "winning"
        postSearch.elasticsearch data: query: match: text: "win"
        postSearch.elasticsearch data: query: match: text: "#winnings"
        postSearch.elasticsearch data: query: match: text: "#winning"
        postSearch.elasticsearch data: query: match: text: "#win"
    .then (results) ->
      assert.eq
        0 0 0,
        1 1 1
        array out from results with out.hits.total

